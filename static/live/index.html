<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Substrate Analytics - Live - Single Node (Detail)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link rel=stylesheet href=https://cdn.jsdelivr.net/npm/pretty-print-json@0.2/dist/pretty-print-json.css>
    <script src=https://cdn.jsdelivr.net/npm/pretty-print-json@0.2/dist/pretty-print-json.min.js></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
</head>
<body>


<nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-menu is-active">
        <div class="navbar-start">
            <div class=" navbar-item">
                <h1 class="title">
                    Substrate Analytics | Live - Single Node (Detail)
                </h1>
            </div>

            <div class="navbar-item">
                <div class="field">
                    <div class="control">
                        <div class="select">
                            <select id="node-select">
                            </select>
                        </div>
                    </div>
                </div>
            </div>


            <div class="navbar-item">
                <div class="field">
                    <div class="control">
                        <button class="button is-primary" onclick="initialiseFeed()">View</button>
                    </div>
                </div>
            </div>
            <div class="navbar-item">
                <div class="field">
                    <div class="control">
                        <button class="button is-secondary" onclick="stopFeed()">Cancel</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</nav>

<template id="graph-template">
    <div class="container"></div>
</template>

<section class="section">
    <div class="container">

        <div id="benchmark-info" class="notification"></div>
    </div>
</section>

<section class="section" id="graphs">
</section>

<script>
    const minutesToShow = 5;

    class Subscription {
        constructor(peer_id, msg, start_time, interest) {
            this.peer_id = peer_id;
            this.msg = msg;
            this.start_time = start_time;
            this.interest = interest;
        }
    }
    let nodes = new Map();
    const nodeSelect = document.querySelector('#node-select');
    // const targetSelect = document.querySelector('#target-select');

    nodeSelect.addEventListener('change', (event) => {

    });

    function initialiseFeed() {
        stopFeed();
        let peer_id = document.getElementById('node-select').value;
        let start_time = moment().subtract(minutesToShow, 'minutes').format('YYYY-MM-DD[T]HH:mm:ss.SSSSSS');
        let subscription = new Subscription(peer_id, 'tracing.profiling', start_time, 'subscribe' );
        socket.send(JSON.stringify(subscription));
    }

    function stopFeed() {
        let peer_id = document.getElementById('node-select').value;
        let subscription = new Subscription(peer_id, 'tracing.profiling', "", 'unsubscribe' );
        socket.send(JSON.stringify(subscription));
    }

    function loadNodes() {
        nodeSelect.options.length = 0;
        nodes.set(0, "Please select a node");
        const opt = new Option("Please select a node", 0);
        nodeSelect.options.add(opt);
        let request = new Request('/nodes');
        fetch(request)
            .then(response => response.json())
            .then(json => {
                for (const node of json) {
                    nodes.set(node.id, node);
                    const opt = new Option(node.peer_id, node.peer_id);
                    nodeSelect.options.add(opt);
                }
            });
    }

    loadNodes();

</script>

<script>
    let socket = new WebSocket(`ws://${window.location.host}/feed`);
    let traceData = new Map();
    let graph = undefined;

    function processData(data) {
        let json = JSON.parse(data);
        if (json.peer_message.msg !== "tracing.profiling") {
            console.log(`Message received: ${json.peer_message.msg}`)
            return;
        }
        for (const element of json.data) {
            if (!traceData.has(element.log.name)) {
                traceData.set(element.log.name, new Map());
            }
            let nameMap = traceData.get(element.log.name);
            if (!nameMap.has(element.log.target)) {
                nameMap.set(element.log.target, [[],[],[]]);
            }
            let arr = nameMap.get(element.log.target);
            // getTruncateIndex(arr[0]);
            arr[0].push(new Date(element.created_at));
            arr[1].push(element.log.time);
            arr[2].push(`Values: ${element.log.values}`);
        }
        updatePlots();
    }

    function getTruncateIndex(arr) {
        const start_time = moment().subtract(minutesToShow, 'minutes');
        for (let i = 0; i < arr.length; i++) {
            if (arr[i] < start_time) {
                console.log(`Truncate index = ${i}`);
                return i;
            }
        }
    }
    
    function initialiseGraph() {
        let traces = [];
        for (const [name, targetMap] of traceData) {
            let nameTraces = [];
            for ([target, values] of targetMap) {
                nameTraces.push({
                    x: values[0],
                    y: values[1],
                    name: `${target}::${name}`,
                    type: "scatter",
                    mode: 'lines+markers'
                });
            }
            traces.push(nameTraces);
        }
        console.log(traces);

        Plotly.newPlot('graphs', traces);
    }

    function updatePlots() {
        if (graph === undefined) {
            initialiseGraph();
        }
        // let graphName = `${graph_data[0].logs.target}::${graph_data[0].logs.name}`;
        // let yData = graph_data.map(function (obj) {
        //     return obj.logs.time / 1000000;
        // });
        // let trace = {
        //     type: "scatter",
        //     mode: "lines+markers",
        //     name: graphName,
        //     y: yData,
        //     x: graph_data.map(function (obj) {
        //         return new Date(obj.created_at);
        //     }),
        //     text: graph_data.map(function (obj) {
        //         return prettyPrintJson.toHtml(obj.logs);
        //     }),
        //     marker: { size: 8 },
        //
        // }
        // let data = [trace];
        // let layout = {
        //     title: graphName,
        //     xaxis: {range: [new Date(start_x), new Date(end_x)]},
        //     yaxis: { title: "Execution time (ms)"}
        // };
        // let template = document.querySelector('#graph-template');
        // var node = template.content.cloneNode(true);
        // var divItem = node.querySelector('div');
        // divItem.id = graphName;
        // document.getElementById('graphs').appendChild(node);
        // Plotly.newPlot(graphName, data, layout);
    }

    socket.onmessage = function(event) {
        console.log(`[message] Data received from server:`);
        console.log(`Received ${event.data.length} logs from server`);
        processData(event.data);
    };

    socket.onopen = function(e) {
        console.log("[open] Connection established");
    };

    socket.onclose = function(event) {
        if (event.wasClean) {
            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            console.log('[close] Connection died');
        }
    };

    socket.onerror = function(error) {
        console.log(`[error] ${error.message}`);
    };
</script>
</body>
</html>
